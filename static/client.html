<html xmlns="http://www.w3.org/1999/xhtml" lang="en">

<head>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.3/jquery.min.js"></script>
</head>

<body>
    <p>
        <b>This is an incomplete mock-up of the client, for design purposes. This page is not fully functional.</b>
    </p>
    <div id="output">
        <p>Welcome, commander.</p>
        <p>Commands: scan, summary, agenda, burn, cancel</p>
    </div>

    <br>
    <input type="text" id="command">
    <input type="button" value="Enter command" id="submit_btn" onclick="handle_input()">
    <hr>
    <p>Authcode: <input id="authcode" type="text"></p>
    <p>Vessel: <input type="text" id="vessel"></p>
    <p>System: <input type="text" id="system" value="{{GAMENAME}}" disabled></p>

</body>

</html>

<script>

    function handle_input(params) {
        let command = $("#command").val();
        display("<pre>> " + command + "</pre>");
        result = handle(parse(command));
        display(result + "<hr>");
    }

    function get_vessel() {
        return $("#vessel").val();
    }

    function get_authcode() {
        return $("#authcode").val();
    }

    function get_system() {
        return $("#system").val();
    }

    function display(html) {
        //add html to the 'navigation console'
        out = $("#output");
        out.innerHTML += html;
    }

    function parse(str) {
        let m;
        // what a readable one-liner amirite
        let match = ((m = /\b(?:burn|cancel|scan|summary|agenda)\b/.exec(str)) ? m[0] : null)

        switch (match) {
            case "burn":
                return {
                    "match": match, "command": str, "parsed": parse_burn(str)
                };
                break
            case "cancel":
                console.log("cancel")
                return {
                    "match": match, "command": str, "parsed": parse_cancel(str)
                };
                break
            case "scan":
                console.log("scan")
                return {
                    "match": match, "command": str, "parsed": parse_scan(str)
                };
                break
            case "summary":
                console.log("summary")
                return {
                    "match": match, "command": str, "parsed": parse_summary(str)
                };
                break
            case "agenda":
                console.log("agenda")
                return {
                    "match": match, "command": str, "parsed": parse_agenda(str)
                };
                break
            default:
                console.log("match fail");
        }
    }

    function handle(args) {
        console.log("overall handler called with " + JSON.stringify(args));
        switch (args.match) {
            case "burn":
                console.log("handling burn");
                return handle_burn(args.parsed);
                break
            case "cancel":
                console.log("handling cancel")
                return handle_cancel(args.parsed);
                break
            case "scan":
                console.log("handling scan")
                return handle_scan(args.parsed);
                break
            case "summary":
                console.log("handling summary")
                return handle_summary(args.parsed);
                break
            case "agenda":
                console.log("handling agenda")
                return handle_agenda(args.parsed);
                break
            default:
                console.log("match fail");
        }
    }

    // ** SPECIFIC COMMAND PARSERS
    function parse_burn(str) {
        let r_burn = /\bburn (-?\d+(?:\.\d+)?) (-?\d+(?:\.\d+)?) (-?\d+(?:\.\d+)?)\b/
        let r_in = /\bin (\d+(?:\.\d+)?) (second|hour|minute|day)s?\b/
        let r_at = /\bat (\d{4}-\d\d-\d\d \d\d:\d\d:\d\d)\b/

        let m_burn = r_burn.exec(str)
        let burn_coords = m_burn.slice(1, 4)

        let m_in
        let m_at
        let time_input
        let interval = false

        if (m_in = r_in.exec(str)) {
            interval = true
            switch (m_in[2]) {
                case "second":
                    time_input = m_in[1]
                    break
                case "minute":
                    time_input = m_in[1] * 60
                    break
                case "hour":
                    time_input = m_in[1] * 60 * 60
                    break
                case "day":
                    time_input = m_in[1] * 60 * 60 * 24
                    break
            }
        } else if (m_at = r_at.exec(str)) {
            time_input = m_at[1]
        } else {
            time_input = null // should be "now"?
        }

        console.log(`a: ${burn_coords}, time_input: ${time_input}, interval?: ${interval}`);
        return {
            "args": { "a": burn_coords },
            "time_input": time_input,
            "interval": interval
        };
    }

    function parse_cancel(str) {
        r = /[\d]+/; //regex to find number
        var order_id = parseInt(r.exec(str)[0]);
        return { order_id }
    }

    function parse_scan(str) {
        return str
    }

    function parse_summary(str) {
        return str
    }

    function parse_agenda(str) {
        return str
    }

    // specific command execution
    // BURN
    function handle_burn(args) {
        args["task"] = "burn";
        args.time = args.time_input;
        args = JSON.stringify(args);
        console.log("in burn handler, args " + args);
        response = post_local("/game/" + get_system() + "/add_order", "html=1&authcode=" + get_authcode() + "&vessel=" + get_vessel() + "&order=" + args);
        console.log("response is " + response);
        return response;
    }

    // CANCEL
    function handle_cancel(args) {
        response = post_local("/game/" + get_system() + "/delete_order", "html=1&authcode=" + get_authcode() + "&vessel=" + get_vessel() + "&order_id=" + args.order_id);
        console.log("response is " + response);
        return response;
    }

    // SCAN
    function handle_scan(args) {
        console.log("in scan handler, args " + args);
        response = post_local("/game/" + get_system() + "/scan", "html=1");
        console.log("response is " + response);
        return response;
    }
    // SUMMARY
    function handle_summary(args) {
        response = post_local("/game/" + get_system() + "/summary", "html=1");
        return response;
    }
    // AGENDA
    function handle_agenda(args) {
        response = post_local("/game/" + get_system() + "/agenda", "html=1&authcode=" + get_authcode() + "&vessel=" + get_vessel());
        return response;
    }
    //** END COMMAND-SPECIFIC HANDLERS**

    function post_local(url, body) {
        $.post(url, body=body, function(data) {
            if (data.status === 200 || data.status != 404) {
                console.log("received:\n" + data)
                return data.responseText;
            } else if (data.status === 404) {
                console.log("received 404")
            }
        });
    }
</script>